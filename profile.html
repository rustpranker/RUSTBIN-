<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF‑8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Profile - Rustbin</title>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body, html {
      height: 100%; background: #0a0a2a;
      font-family: 'Fira Code', monospace; color: #e0e0f0;
      position: relative; overflow-x: hidden;
    }
    .snowflake { position: absolute; top: -10px; color: #fff;
      user-select: none; pointer-events: none;
      font-size: 24px; animation: fall linear infinite; }
    @keyframes fall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
    }
    .main-content { position: relative; z-index: 1;
      max-width: 800px; margin: 0 auto; padding: 30px 20px;
      display: flex; flex-direction: column; align-items: center; }
    h1 {
      font-size: 2.5em;
      background: linear-gradient(270deg,#8e44ad,#fff);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientMove 6s ease infinite;
      margin-bottom: 30px;
    }
    @keyframes gradientMove {
      0%,100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    .profile-container {
      background: rgba(17,17,34,0.85);
      padding: 25px; border-radius: 8px; width: 100%;
      box-shadow: 0 0 20px rgba(142,68,173,0.7);
    }
    .avatar {
      width: 150px; height: 150px; border-radius: 50%;
      object-fit: cover; border: 3px solid #8e44ad;
      display: block; margin: 0 auto 20px;
    }
    label { margin-top: 15px; font-weight: bold; display: block; }
    input[type="file"], input[type="text"], textarea, select {
      width: 100%; background: #222; color: #fff;
      border: none; border-radius: 6px; padding: 10px;
      font-size: 14px; margin-top: 5px;
    }
    textarea { resize: vertical; min-height: 80px; }
    button {
      margin-top: 20px; background-color: #8e44ad;
      padding: 10px 20px; color: white;
      border: none; border-radius: 6px;
      font-weight: bold; cursor: pointer;
      transition: background-color .3s;
    }
    button:hover:not(:disabled) { background-color: #6a1b9a; }
    button:disabled { background-color: #4a148c; cursor: not-allowed; }
    .info { margin-top: 15px; font-size: 14px; color: #bbb; text-align: center; }
    .error, .success { text-align: center; margin-top: 10px; font-weight: bold; }
    .error { color: #ff5555; }
    .success { color: #55ff55; }
    #userPastesList > div {
      border-bottom: 1px solid #333;
      padding: 6px 0; cursor: pointer;
    }
    #userPastesList > div:hover {
      color: #8e44ad; text-decoration: underline;
    }
    #backHomeBtn { margin-top: 15px; background-color: #555; }
    #backHomeBtn:hover { background-color: #888; }
    @media (max-width: 600px) {
      .avatar { width: 120px; height: 120px; }
      .profile-container { padding: 15px; }
    }
  </style>
</head>
<body>
  <!-- Snowflakes -->
  <script>
    const snowCount = 50;
    for (let i = 0; i < snowCount; i++) {
      const snow = document.createElement('div');
      snow.className = 'snowflake';
      snow.style.left = Math.random() * 100 + 'vw';
      snow.style.opacity = Math.random();
      snow.style.fontSize = Math.random() * (32 - 16) + 16 + 'px';
      snow.style.animationDuration = Math.random() * (20 - 10) + 10 + 's';
      snow.style.animationDelay = Math.random() * 20 + 's';
      snow.textContent = '❄';
      document.body.appendChild(snow);
    }
  </script>

  <div class="main-content">
    <h1>Your Profile</h1>
    <div class="profile-container">
      <img id="avatar" class="avatar" src="" alt="Avatar"
           onerror="this.src='https://via.placeholder.com/150?text=No+Avatar'">
      <label>Change Avatar:</label><input type="file" id="avatarInput" accept="image/*">
      <label>Display Name:</label><input type="text" id="displayNameInput" maxlength="30">
      <label>Nickname Color:</label>
      <select id="colorSelect">
        <option value="#FFFFFF">White</option>
        <option value="#FF0000">Red</option>
        <option value="#800080">Purple</option>
        <option value="#008000">Green</option>
        <option value="#FFFF00">Yellow</option>
        <option value="#4a148c">Dark Violet</option>
        <option value="#d1b3ff">Light Purple</option>
      </select>
      <label>Description:</label>
      <textarea id="descriptionInput" placeholder="Write something..."></textarea>
      <div class="info" id="registrationDate">Registration Date: --</div>
      <button id="saveProfileBtn">Save Profile</button>
      <button id="backHomeBtn" type="button">Back to Home</button>
      <div class="success" id="successMsg" style="display:none;">Saved!</div>
      <div class="error" id="errorMsg" style="display:none;"></div>
      <h2 style="text-align:center; margin-top:30px;">Your Pastes</h2>
      <div id="userPastesList" style="max-height:250px; overflow-y:auto;"></div>
    </div>
  </div>

  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    const avatarImg = document.getElementById('avatar');
    const avatarInput = document.getElementById('avatarInput');
    const displayNameInput = document.getElementById('displayNameInput');
    const colorSelect = document.getElementById('colorSelect');
    const descriptionInput = document.getElementById('descriptionInput');
    const registrationDateDiv = document.getElementById('registrationDate');
    const saveBtn = document.getElementById('saveProfileBtn');
    const successMsg = document.getElementById('successMsg');
    const errorMsg = document.getElementById('errorMsg');
    const backHomeBtn = document.getElementById('backHomeBtn');

    let currentUser = null;
    let currentAvatarFile = null;
    avatarInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        currentAvatarFile = file;
        const reader = new FileReader();
        reader.onload = evt => avatarImg.src = evt.target.result;
        reader.readAsDataURL(file);
      }
    });
    backHomeBtn.addEventListener('click', () => window.location.href = 'index.html');

    function loadUserProfile(uid) {
      db.collection('users').doc(uid).get()
        .then(doc => {
          if (!doc.exists) return errorMsg.textContent = 'User not found.', errorMsg.style.display = 'block';
          const data = doc.data();
          avatarImg.src = data.avatarURL || avatarImg.src;
          displayNameInput.value = data.displayName || '';
          colorSelect.value = data.color || '#FFFFFF';
          descriptionInput.value = data.description || '';
          registrationDateDiv.textContent = data.createdAt?.toDate
            ? `Registration Date: ${data.createdAt.toDate().toLocaleDateString()}`
            : 'Registration Date: --';
          loadUserPastes(uid);
        })
        .catch(() => errorMsg.textContent = 'Error loading profile.', errorMsg.style.display = 'block');
    }

    function loadUserPastes(uid) {
      const pastes = document.getElementById('userPastesList');
      pastes.textContent = 'Loading...';
      db.collection('pastes').where('ownerId','==',uid).orderBy('createdAt','desc').limit(10).get()
        .then(snapshot => {
          pastes.innerHTML = '';
          snapshot.empty ? pastes.textContent = 'No pastes.' :
            snapshot.forEach(d => {
              const div = document.createElement('div');
              div.textContent = d.data().title || '(Untitled)';
              div.onclick = () => window.location.href = `paste.html?id=${d.id}`;
              pastes.appendChild(div);
            });
        })
        .catch(() => pastes.textContent = 'Error loading pastes.');
    }

    saveBtn.addEventListener('click', async () => {
      if (!currentUser) return;
      saveBtn.disabled = true;
      successMsg.style.display = errorMsg.style.display = 'none';
      try {
        let avatarURL = avatarImg.src;
        if (currentAvatarFile) {
          const ref = storage.ref().child(`avatars/${currentUser.uid}_${Date.now()}.${currentAvatarFile.name.split('.').pop()}`);
          const snap = await ref.put(currentAvatarFile);
          avatarURL = await snap.ref.getDownloadURL();
        }
        await db.collection('users').doc(currentUser.uid).set({
          displayName: displayNameInput.value.trim(),
          color: colorSelect.value,
          description: descriptionInput.value.trim(),
          avatarURL,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        successMsg.style.display = 'block';
      } catch {
        errorMsg.style.display = 'block'; errorMsg.textContent = 'Error saving profile.';
      } finally { saveBtn.disabled = false; currentAvatarFile = null; }
    });

    auth.onAuthStateChanged(user => {
      if (user) { currentUser = user; loadUserProfile(user.uid); }
      else window.location.href = 'index.html';
    });
  </script>
</body>
</html>
