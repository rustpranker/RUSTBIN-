<script>
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  const avatarImg = document.getElementById('avatar');
  const avatarInput = document.getElementById('avatarInput');
  const displayNameInput = document.getElementById('displayNameInput');
  const colorSelect = document.getElementById('colorSelect');
  const descriptionInput = document.getElementById('descriptionInput');
  const saveBtn = document.getElementById('saveBtn');
  const backHomeBtn = document.getElementById('backHomeBtn');
  const successMessage = document.getElementById('successMessage');

  let currentUser = null;
  let avatarFile = null;

  backHomeBtn.onclick = () => {
    window.location.href = 'index.html';
  };

  avatarInput.addEventListener('change', e => {
    if (e.target.files && e.target.files[0]) {
      avatarFile = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(event) {
        avatarImg.src = event.target.result;
      };
      reader.readAsDataURL(avatarFile);
    }
  });

  auth.onAuthStateChanged(user => {
    if (!user) {
      alert('Please login first.');
      window.location.href = 'index.html';
      return;
    }
    currentUser = user;
    loadProfile();
  });

  async function loadProfile() {
    try {
      const doc = await db.collection('users').doc(currentUser.uid).get();
      if (doc.exists) {
        const data = doc.data();
        avatarImg.src = data.avatarURL || 'https://via.placeholder.com/160?text=Avatar';
        displayNameInput.value = data.displayName || '';
        colorSelect.value = data.color || '#8e44ad';
        descriptionInput.value = data.description || '';
      }
    } catch (error) {
      console.error('Error loading profile:', error);
    }
  }

  saveBtn.addEventListener('click', async () => {
    saveBtn.disabled = true;
    successMessage.style.display = 'none';

    try {
      let avatarURL = avatarImg.src;

      // Если avatarFile существует - загружаем файл в Firebase Storage и получаем ссылку
      if (avatarFile) {
        const storageRef = storage.ref();
        const avatarRef = storageRef.child(`avatars/${currentUser.uid}_${Date.now()}`);
        const uploadTaskSnapshot = await avatarRef.put(avatarFile);
        avatarURL = await uploadTaskSnapshot.ref.getDownloadURL();
      } else {
        // Проверка, что avatarImg.src - это уже URL, а не base64 data URL
        if (avatarURL.startsWith('data:')) {
          // Если это data URL (например, пользователь не загрузил новый файл, а картинка - base64), заменяем на дефолт
          avatarURL = 'https://via.placeholder.com/160?text=Avatar';
        }
      }

      await db.collection('users').doc(currentUser.uid).set({
        displayName: displayNameInput.value.trim(),
        color: colorSelect.value,
        description: descriptionInput.value.trim(),
        avatarURL: avatarURL,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });

      successMessage.style.display = 'block';
      setTimeout(() => {
        successMessage.style.display = 'none';
      }, 3000);

      avatarFile = null; // сбросить, чтобы не пытаться снова загрузить старый файл

    } catch (e) {
      alert('Error saving profile: ' + e.message);
      console.error(e);
    } finally {
      saveBtn.disabled = false;
    }
  });
</script>
