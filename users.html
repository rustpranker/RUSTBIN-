<script>
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  const avatarImg = document.getElementById('avatar');
  const avatarInput = document.getElementById('avatarInput');
  const displayNameInput = document.getElementById('displayNameInput');
  const colorSelect = document.getElementById('colorSelect');
  const descriptionInput = document.getElementById('descriptionInput');
  const registrationDateDiv = document.getElementById('registrationDate');
  const saveBtn = document.getElementById('saveProfileBtn');
  const successMsg = document.getElementById('successMsg');
  const errorMsg = document.getElementById('errorMsg');
  const backHomeBtn = document.getElementById('backHomeBtn');

  const urlParams = new URLSearchParams(window.location.search);
  const viewedUID = urlParams.get("uid"); // Если есть — это чужой профиль

  let currentUser = null;
  let currentAvatarFile = null;

  avatarInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) {
      currentAvatarFile = file;
      const reader = new FileReader();
      reader.onload = function(event) {
        avatarImg.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  });

  backHomeBtn.addEventListener('click', () => {
    window.location.href = 'index.html';
  });

  function loadUserProfile(uid) {
    db.collection('users').doc(uid).get()
      .then(doc => {
        if (!doc.exists) {
          errorMsg.style.display = 'block';
          errorMsg.textContent = 'User not found.';
          return;
        }

        const data = doc.data();
        avatarImg.src = data.avatarURL || 'https://via.placeholder.com/150?text=No+Avatar';
        displayNameInput.value = data.displayName || '';
        colorSelect.value = data.color || '#FFFFFF';
        descriptionInput.value = data.description || '';

        if (data.createdAt && data.createdAt.toDate) {
          registrationDateDiv.textContent = 'Registration Date: ' + data.createdAt.toDate().toLocaleDateString();
        } else {
          registrationDateDiv.textContent = 'Registration Date: --';
        }

        loadUserPastes(uid);

        // Блокируем поля, если это не твой профиль
        if (!currentUser || currentUser.uid !== uid) {
          avatarInput.disabled = true;
          displayNameInput.disabled = true;
          colorSelect.disabled = true;
          descriptionInput.disabled = true;
          saveBtn.style.display = 'none';
        }
      })
      .catch(err => {
        console.error(err);
        errorMsg.style.display = 'block';
        errorMsg.textContent = 'Error loading profile.';
      });
  }

  function loadUserPastes(uid) {
    const pastesList = document.getElementById('userPastesList');
    pastesList.innerHTML = 'Loading pastes...';

    db.collection('pastes')
      .where('ownerId', '==', uid)
      .orderBy('createdAt', 'desc')
      .limit(10)
      .get()
      .then(snapshot => {
        if (snapshot.empty) {
          pastesList.textContent = 'No pastes found.';
          return;
        }
        pastesList.innerHTML = '';
        snapshot.forEach(doc => {
          const paste = doc.data();
          const div = document.createElement('div');
          div.textContent = paste.title || '(Untitled)';
          div.style.cursor = 'pointer';
          div.onclick = () => {
            window.location.href = `paste.html?id=${doc.id}`;
          };
          pastesList.appendChild(div);
        });
      })
      .catch(err => {
        pastesList.textContent = 'Error loading pastes.';
        console.error(err);
      });
  }

  saveBtn.addEventListener('click', async () => {
    if (!currentUser) return;
    saveBtn.disabled = true;
    successMsg.style.display = 'none';
    errorMsg.style.display = 'none';

    try {
      let avatarURL = avatarImg.src;

      if (currentAvatarFile) {
        const storageRef = storage.ref();
        const avatarRef = storageRef.child(`avatars/${currentUser.uid}_${Date.now()}.${currentAvatarFile.name.split('.').pop()}`);
        const snapshot = await avatarRef.put(currentAvatarFile);
        avatarURL = await snapshot.ref.getDownloadURL();
      }

      await db.collection('users').doc(currentUser.uid).set({
        displayName: displayNameInput.value.trim(),
        color: colorSelect.value,
        description: descriptionInput.value.trim(),
        avatarURL: avatarURL,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });

      successMsg.style.display = 'block';
      currentAvatarFile = null;
    } catch (err) {
      console.error(err);
      errorMsg.style.display = 'block';
      errorMsg.textContent = 'Error saving profile.';
    } finally {
      saveBtn.disabled = false;
    }
  });

  auth.onAuthStateChanged(user => {
    currentUser = user;

    // Если ?uid задан — смотрим чужой профиль, иначе свой
    if (viewedUID) {
      loadUserProfile(viewedUID);
    } else if (user) {
      loadUserProfile(user.uid);
    } else {
      // Гость и без uid — редирект
      window.location.href = 'index.html';
    }
  });
</script>
