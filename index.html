<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rustbin</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <!-- Firebase config -->
  <script src="firebase-config.js"></script>

  <style>
    body {
      background-color: #000;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      position: relative;
      overflow-x: hidden;
    }

    /* Снежинки */
    .snowflake {
      position: fixed;
      top: -10px;
      color: white;
      font-size: 1em;
      pointer-events: none;
      animation: fall linear infinite;
    }
    @keyframes fall {
      to {
        transform: translateY(100vh);
      }
    }

    .navbar {
      background-color: #1a0033;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar a {
      color: #d29cff;
      text-decoration: none;
      margin: 0 12px;
      font-weight: bold;
      font-size: 16px;
      padding: 8px 16px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .navbar a:hover {
      background-color: #3a005f;
    }

    .title-container {
      text-align: center;
      margin-top: 40px;
      position: relative;
    }
    .gradient-text {
      font-size: 48px;
      font-weight: bold;
      background: linear-gradient(270deg, #8e44ad, #ffffff);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientMove 4s ease infinite;
    }
    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .credit-text {
      font-size: 14px;
      color: #9b59b6;
      margin-top: 8px;
    }
    .official-text {
      font-size: 14px;
      color: #8e44ad;
      margin-top: 4px;
    }

    .search-bar {
      margin-top: 20px;
    }
    .search-bar input {
      padding: 10px;
      width: 220px;
      border-radius: 6px;
      border: none;
      outline: none;
      background-color: #2c2c3a;
      color: white;
    }
    .search-bar button {
      padding: 10px 16px;
      background-color: #8e44ad;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-left: 6px;
      font-weight: bold;
      font-size: 14px;
      box-shadow: 0 0 10px #8e44ad;
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    .search-bar button:hover {
      background-color: #732d91;
      box-shadow: 0 0 15px #732d91;
    }

    #counter {
      margin-top: 15px;
      font-size: 14px;
      color: #ccc;
    }

    .pastes-list {
      margin: 30px auto;
      max-width: 700px;
    }
    .paste-preview {
      background-color: #1a0033;
      padding: 12px 16px;
      margin: 10px 0;
      border: 1px solid #3a005f;
      border-left: 5px solid #8e44ad;
      cursor: pointer;
      border-radius: 6px;
      font-weight: bold;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.3s;
    }
    .paste-preview:hover {
      background-color: #3a005f;
    }
    .paste-meta {
      font-size: 12px;
      color: #d29cff;
      margin-top: 4px;
    }
    .pagination {
      text-align: center;
      margin: 20px 0;
    }
    .pagination button {
      background-color: #2c2c3a;
      color: #d29cff;
      border: none;
      padding: 8px 12px;
      margin: 0 3px;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 0 8px #8e44ad;
      transition: background-color 0.3s, box-shadow 0.3s;
      font-family: monospace;
    }
    .pagination button.active {
      background-color: #8e44ad;
      color: white;
      box-shadow: 0 0 15px #8e44ad;
    }
    .pagination button:hover:not(.active) {
      background-color: #732d91;
      box-shadow: 0 0 15px #732d91;
      color: white;
    }

    /* Роли */
    .role-admin { color: #ff4d4d; }
    .role-coowner { color: #d29cff; }
    .role-coder { color: #2ecc71; }
    .role-rich { color: #f1c40f; }

    /* Переливающаяся надпись сбоку */
    .side-text {
      position: fixed;
      right: -40px;
      top: 50%;
      transform: rotate(-90deg) translateY(-50%);
      font-size: 32px;
      font-weight: bold;
      background: linear-gradient(270deg, #8e44ad, #ffffff);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientMove 4s ease infinite;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <!-- Снежинки -->
  <div id="snow"></div>

  <nav class="navbar">
    <div class="nav-left">
      <a href="index.html">Home</a>
      <a href="create.html">Add Paste</a>
      <a href="users.html">Users</a>
    </div>
    <div class="nav-right" id="auth-buttons">
      <a href="register.html">Register</a>
      <a href="login.html">Login</a>
    </div>
  </nav>

  <div class="title-container">
    <h1 class="gradient-text">RUSTBIN</h1>
    <img src="https://media.tenor.com/rkAEqes681cAAAAi/purple-heart-purple.gif" alt="logo" style="max-width: 150px; margin: 20px auto;" />
    <p class="credit-text">created by kostya rjaviy, destroymymemories<br>contact dc: wg2d, destroymymemories</p>
    <p class="official-text">official site by kostya rjaviy</p>

    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search pastes by title..." />
      <button onclick="searchPastes()">Search</button>
    </div>

    <div id="counter">Loaded 0 of 0</div>

    <div style="margin-top: 15px;">
      <input type="text" id="roleInput" placeholder="Enter your UID to get role" style="padding:8px; border-radius:4px; border:none; width: 220px;"/>
      <button id="getRoleBtn" style="background-color: #8e44ad; color: white; font-weight: bold; border:none; border-radius: 4px; padding: 8px 16px; cursor: pointer; margin-left: 6px;">Get Role</button>
      <div id="roleStatus"></div>
    </div>
  </div>

  <div id="pastes-list" class="pastes-list"></div>

  <div class="pagination" id="pagination"></div>

<script>
  const authButtonsDiv = document.getElementById('auth-buttons');
  const pastesList = document.getElementById('pastes-list');
  const searchInput = document.getElementById('searchInput');
  const getRoleBtn = document.getElementById('getRoleBtn');
  const roleInput = document.getElementById('roleInput');
  const roleStatus = document.getElementById('roleStatus');
  const counterDiv = document.getElementById('counter');
  const paginationDiv = document.getElementById('pagination');

  let allPastes = [];
  let currentPage = 1;
  const itemsPerPage = 20;

  const auth = firebase.auth();
  const db = firebase.firestore();

  const rolesMap = {
    "ZJl09Nb8cx": "admin",
    "N8Jxcl0z6d": "coowner",
    "Zn9Jx7Lmn1": "coder",
    "Sj9xn23Bcv": "rich"
  };
  const rolesColorClass = {
    "admin": "role-admin",
    "coowner": "role-coowner",
    "coder": "role-coder",
    "rich": "role-rich"
  };

  async function updateAuthUI(user) {
    if (!user) {
      authButtonsDiv.innerHTML = `
        <a href="register.html">Register</a>
        <a href="login.html">Login</a>
      `;
      return;
    }
    try {
      const userDoc = await db.collection('users').doc(user.uid).get();
      let role = userDoc.exists ? userDoc.data().role : rolesMap[user.uid];
      const roleClass = role && rolesColorClass[role] ? rolesColorClass[role] : '';
      authButtonsDiv.innerHTML = `
        <span class="${roleClass}">${user.displayName || user.email}</span>
        <button id="logoutBtn" style="background:none; border:none; color:#ff4d4d; cursor:pointer; font-weight:bold; margin-left:10px;">Logout</button>
      `;
      document.getElementById('logoutBtn').onclick = () => firebase.auth().signOut();
    } catch {
      authButtonsDiv.innerHTML = `
        <span>${user.displayName || user.email}</span>
        <button id="logoutBtn" style="background:none; border:none; color:#ff4d4d; cursor:pointer; font-weight:bold; margin-left:10px;">Logout</button>
      `;
      document.getElementById('logoutBtn').onclick = () => firebase.auth().signOut();
    }
  }

  function loadPastes() {
    db.collection('pastes').orderBy('createdAt', 'desc').get()
      .then(snapshot => {
        allPastes = [];
        snapshot.forEach(doc => {
          const paste = doc.data();
          allPastes.push({
            id: doc.id,
            title: paste.title || 'Untitled',
            content: paste.content || '',
            createdAt: paste.createdAt ? paste.createdAt.toDate() : new Date(),
            views: paste.views || 0
          });
        });
        counterDiv.textContent = `Loaded ${allPastes.length} of ${allPastes.length}`;
        displayPastes(allPastes);
      });
  }

  function displayPastes(list) {
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const paginatedItems = list.slice(start, end);

    pastesList.innerHTML = '';
    paginatedItems.forEach(paste => {
      const div = document.createElement('div');
      div.className = 'paste-preview';
      div.innerHTML = `
        <div>
          ${paste.title}
          <div class="paste-meta">${paste.views} views • ${paste.createdAt.toLocaleDateString()}</div>
        </div>
      `;
      div.onclick = () => {
        // При клике увеличиваем просмотры, затем открываем пасту
        const pasteRef = db.collection('pastes').doc(paste.id);
        pasteRef.update({
          views: firebase.firestore.FieldValue.increment(1)
        }).finally(() => {
          window.location.href = `paste.html?id=${paste.id}`;
        });
      };
      pastesList.appendChild(div);
    });

    renderPagination(list.length);
  }

  function renderPagination(totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    paginationDiv.innerHTML = '';
    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      if (i === currentPage) btn.classList.add('active');
      btn.onclick = () => {
        currentPage = i;
        displayPastes(allPastes);
      };
      paginationDiv.appendChild(btn);
    }
  }

  function searchPastes() {
    const query = searchInput.value.trim().toLowerCase();
    const filtered = !query ? allPastes : allPastes.filter(p => p.title.toLowerCase().includes(query));
    counterDiv.textContent = `Loaded ${filtered.length} of ${allPastes.length}`;
    currentPage = 1;
    displayPastes(filtered);
  }

  getRoleBtn.onclick = async () => {
    const enteredUID = roleInput.value.trim();
    if (!enteredUID) {
      roleStatus.textContent = 'Введите UID';
      roleStatus.className = 'error';
      return;
    }
    const role = rolesMap[enteredUID];
    if (!role) {
      roleStatus.textContent = 'Incorrect!';
      roleStatus.className = 'error';
      return;
    }
    const user = auth.currentUser;
    if (!user) {
      roleStatus.textContent = 'Вы должны войти в аккаунт';
      roleStatus.className = 'error';
      return;
    }
    if (user.uid !== enteredUID) {
      roleStatus.textContent = 'UID не совпадает с вашим';
      roleStatus.className = 'error';
      return;
    }
    await db.collection('users').doc(user.uid).set({ role }, { merge: true });
    updateAuthUI(user);
    roleStatus.textContent = `Successful! You got the role "${role}"`;
    roleStatus.className = 'success';
    roleInput.value = '';
  };

  firebase.auth().onAuthStateChanged(user => {
    updateAuthUI(user);
    loadPastes();
  });

  // Снежинки
  function createSnowflake() {
    const snowflake = document.createElement('div');
    snowflake.classList.add('snowflake');
    snowflake.textContent = '.';
    snowflake.style.left = Math.random() * window.innerWidth + 'px';
    snowflake.style.fontSize = (Math.random() * 10 + 10) + 'px';
    snowflake.style.animationDuration = (Math.random() * 5 + 5) + 's';
    document.getElementById('snow').appendChild(snowflake);
    setTimeout(() => snowflake.remove(), 10000);
  }
  setInterval(createSnowflake, 200);
</script>
</body>
</html>
